# Beschreibt wie unsere CI/CD Pipeline mit der Gitlab-CI funktioniert
#
# Referenz: https://docs.gitlab.com/ce/ci/yaml/
# Linter: https://gitlab.emundo.eu/ci/lint
# Doku: https://gitlab.emundo.eu/help/ci/README.md
#
# Author: Robert Schreib

image: emundo/docker-compose-openjdk-node-gradle:openjdk-8-gradle-5.1

variables:
  # Deaktiviere den Gradle Daemon: https://docs.gradle.org/current/userguide/gradle_daemon.html#sec:why_the_daemon
  # Verwende nicht GRADLE_OPTS sondern JAVA_OPTS, sonst wird die JVM nicht mit den Settings gestartet
  JAVA_OPTS: "-Xmx4096m -Dorg.gradle.daemon=false -Dorg.gradle.caching=false"


stages:
  - build
  - publish

assemble:
  stage: build
  script:
    - gradle assemble

publish:
  stage: publish
  only:
    - tags
  script:
    - echo "gradle.publish.key=$GRADLE_PUBLISH_KEY" >> gradle.properties
    - echo "gradle.publish.secret=$GRADLE_PUBLISH_SECRET" >> gradle.properties
    - gradle publishPlugins
    # Remove Secrets
    - rm gradle.properties
